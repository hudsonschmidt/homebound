# Database Migrations with Alembic

This project uses Alembic for database migrations. All database schema changes should be managed through Alembic migrations.

## Setup

Alembic is already configured and ready to use. The configuration files are:
- `alembic.ini` - Main configuration file
- `alembic/env.py` - Environment configuration (handles async SQLAlchemy)
- `alembic/versions/` - Directory containing migration files

## Common Commands

### Check current migration status
```bash
alembic current
```

### Apply all migrations (update database to latest schema)
```bash
alembic upgrade head
```

### Create a new migration automatically
```bash
# This will detect changes in your models and create a migration
alembic revision --autogenerate -m "Description of changes"
```

### Create a new migration manually
```bash
alembic revision -m "Description of changes"
```

### Downgrade to previous migration
```bash
alembic downgrade -1
```

### View migration history
```bash
alembic history
```

## Production Deployment

On Render.com or other production environments, migrations are automatically run before starting the application:

```bash
alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

This is configured in `render.yaml`.

## Adding a New Table or Column

1. **Modify your SQLAlchemy models** in `app/models.py`

2. **Generate a migration**:
   ```bash
   alembic revision --autogenerate -m "Add table_name or column_name"
   ```

3. **Review the generated migration** in `alembic/versions/`
   - Check that the upgrade and downgrade functions are correct
   - Sometimes autogenerate misses things or gets things wrong

4. **Test the migration locally**:
   ```bash
   alembic upgrade head
   ```

5. **Commit the migration file** to version control

6. **Deploy** - The migration will run automatically on deployment

## Fresh Database Setup

If you're setting up a completely fresh database:

```bash
# Create all tables from scratch
alembic upgrade head
```

## Existing Database

If you have an existing database that wasn't created with Alembic:

```bash
# Mark the database as up-to-date with the initial migration
alembic stamp head
```

## Troubleshooting

### "relation already exists" error
If you get this error when running migrations, your database already has the tables. Use:
```bash
alembic stamp head
```

### Connection errors
Make sure your `DATABASE_URL` environment variable is set correctly:
- For local SQLite: `sqlite:///homebound.db`
- For PostgreSQL: `postgresql://user:pass@host:port/dbname`

### Migration conflicts
If you have migration conflicts after merging branches:
1. Check the current state: `alembic current`
2. Review conflicting migrations in `alembic/versions/`
3. You may need to manually merge migrations or create a new one

## Environment Variables

Alembic uses the same `DATABASE_URL` environment variable as the application. Set this in your `.env` file:

```bash
DATABASE_URL=postgresql://username:password@localhost:5432/homebound
```

For SQLite (local development):
```bash
DATABASE_URL=sqlite:///homebound.db
```

## Best Practices

1. **Always review autogenerated migrations** - They might not capture everything correctly
2. **Test migrations locally first** before deploying to production
3. **Keep migrations small and focused** - One logical change per migration
4. **Write meaningful migration messages** - They help track database history
5. **Never edit migrations that have been deployed** - Create new migrations instead
6. **Back up production database** before running major migrations

## Current Schema

The database currently includes these tables:
- `users` - User accounts with saved contacts
- `plans` - Adventure/trip plans
- `contacts` - Emergency contacts for plans
- `events` - Timeline events for plans
- `devices` - Push notification devices
- `login_tokens` - Magic link authentication tokens

All tables support the full feature set including:
- Location coordinates (lat/lng) for trips
- 19 different activity types
- Saved emergency contacts per user
- Event tracking and notifications